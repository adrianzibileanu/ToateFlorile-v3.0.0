import { CurrentResourceStrings } from '../../core/i18n/resources';
import { cloneValue } from '../../core/utils';
import { DataUtil, GridColumnDataType } from '../../data-operations/data-util';
import { FilteringLogic } from '../../data-operations/filtering-expression.interface';
import { FilteringExpressionsTree } from '../../data-operations/filtering-expressions-tree';
import { IgxSorting } from '../common/strategy';
import { IgxPivotAggregate, IgxPivotDateAggregate, IgxPivotNumericAggregate, IgxPivotTimeAggregate } from './pivot-grid-aggregate';
import { PivotDimensionType } from './pivot-grid.interface';
export class PivotUtil {
    // go through all children and apply new dimension groups as child
    static processGroups(recs, dimension, pivotKeys) {
        for (const rec of recs) {
            // process existing children
            if (rec.children && rec.children.size > 0) {
                // process hierarchy in dept
                rec.children.forEach((values) => {
                    this.processGroups(values, dimension, pivotKeys);
                });
            }
            // add children for current dimension
            const hierarchyFields = PivotUtil
                .getFieldsHierarchy(rec.records, [dimension], PivotDimensionType.Row, pivotKeys);
            const siblingData = PivotUtil
                .processHierarchy(hierarchyFields, pivotKeys, 0);
            rec.children.set(dimension.memberName, siblingData);
        }
    }
    static flattenGroups(data, dimension, expansionStates, defaultExpand, parent, parentRec) {
        for (let i = 0; i < data.length; i++) {
            const rec = data[i];
            const field = dimension.memberName;
            if (!field) {
                continue;
            }
            let recordsData = rec.children.get(field);
            if (!recordsData && parent) {
                // check parent
                recordsData = rec.children.get(parent.memberName);
                if (recordsData) {
                    dimension = parent;
                }
            }
            if (parentRec) {
                parentRec.dimensionValues.forEach((value, key) => {
                    if (parent.memberName !== key) {
                        rec.dimensionValues.set(key, value);
                        const dim = parentRec.dimensions.find(x => x.memberName === key);
                        rec.dimensions.unshift(dim);
                    }
                });
            }
            const expansionRowKey = PivotUtil.getRecordKey(rec, dimension);
            const isExpanded = expansionStates.get(expansionRowKey) === undefined ?
                defaultExpand :
                expansionStates.get(expansionRowKey);
            const shouldExpand = isExpanded || !dimension.childLevel || !rec.dimensionValues.get(dimension.memberName);
            if (shouldExpand && recordsData) {
                if (dimension.childLevel) {
                    this.flattenGroups(recordsData, dimension.childLevel, expansionStates, defaultExpand, dimension, rec);
                }
                else {
                    // copy parent values and dims in child
                    recordsData.forEach(x => {
                        rec.dimensionValues.forEach((value, key) => {
                            if (dimension.memberName !== key) {
                                x.dimensionValues.set(key, value);
                                const dim = rec.dimensions.find(y => y.memberName === key);
                                x.dimensions.unshift(dim);
                            }
                        });
                    });
                }
                data.splice(i + 1, 0, ...recordsData);
                i += recordsData.length;
            }
        }
    }
    static assignLevels(dims) {
        for (const dim of dims) {
            let currDim = dim;
            let lvl = 0;
            while (currDim.childLevel) {
                currDim.level = lvl;
                currDim = currDim.childLevel;
                lvl++;
            }
            currDim.level = lvl;
        }
    }
    static getFieldsHierarchy(data, dimensions, dimensionType, pivotKeys) {
        const hierarchy = new Map();
        for (const rec of data) {
            const vals = dimensionType === PivotDimensionType.Column ?
                this.extractValuesForColumn(dimensions, rec, pivotKeys) :
                this.extractValuesForRow(dimensions, rec, pivotKeys);
            for (const [_key, val] of vals) { // this should go in depth also vals.children
                if (hierarchy.get(val.value) != null) {
                    this.applyHierarchyChildren(hierarchy, val, rec, pivotKeys);
                }
                else {
                    hierarchy.set(val.value, cloneValue(val));
                    this.applyHierarchyChildren(hierarchy, val, rec, pivotKeys);
                }
            }
        }
        return hierarchy;
    }
    static sort(data, expressions, sorting = new IgxSorting()) {
        data.forEach(rec => {
            const children = rec.children;
            if (children) {
                children.forEach(x => {
                    this.sort(x, expressions, sorting);
                });
            }
        });
        return DataUtil.sort(data, expressions, sorting);
    }
    static extractValueFromDimension(dim, recData) {
        return dim.memberFunction ? dim.memberFunction.call(null, recData) : recData[dim.memberName];
    }
    static getDimensionDepth(dim) {
        let lvl = 0;
        while (dim.childLevel) {
            lvl++;
            dim = dim.childLevel;
        }
        return lvl;
    }
    static extractValuesForRow(dims, recData, pivotKeys) {
        const values = new Map();
        for (const col of dims) {
            if (recData[pivotKeys.level] && recData[pivotKeys.level] > 0) {
                const childData = recData[pivotKeys.records];
                return this.getFieldsHierarchy(childData, [col], PivotDimensionType.Row, pivotKeys);
            }
            const value = this.extractValueFromDimension(col, recData);
            const objValue = {};
            objValue['value'] = value;
            objValue['dimension'] = col;
            if (col.childLevel) {
                const childValues = this.extractValuesForRow([col.childLevel], recData, pivotKeys);
                objValue[pivotKeys.children] = childValues;
            }
            values.set(value, objValue);
        }
        return values;
    }
    static extractValuesForColumn(dims, recData, pivotKeys, path = []) {
        const vals = new Map();
        let lvlCollection = vals;
        const flattenedDims = this.flatten(dims);
        for (const col of flattenedDims) {
            const value = this.extractValueFromDimension(col, recData);
            path.push(value);
            const newValue = path.join(pivotKeys.columnDimensionSeparator);
            const newObj = { value: newValue, expandable: col.expandable, children: null, dimension: col };
            if (!newObj.children) {
                newObj.children = new Map();
            }
            lvlCollection.set(newValue, newObj);
            lvlCollection = newObj.children;
        }
        return vals;
    }
    static flatten(arr, lvl = 0) {
        const newArr = arr.reduce((acc, item) => {
            item.level = lvl;
            acc.push(item);
            if (item.childLevel) {
                item.expandable = true;
                acc = acc.concat(this.flatten([item.childLevel], lvl + 1));
            }
            return acc;
        }, []);
        return newArr;
    }
    static applyAggregations(rec, hierarchies, values, pivotKeys) {
        if (hierarchies.size === 0) {
            // no column groups
            const aggregationResult = this.aggregate(rec.records, values);
            this.applyAggregationRecordData(aggregationResult, undefined, rec, pivotKeys);
            return;
        }
        hierarchies.forEach((hierarchy) => {
            const children = hierarchy[pivotKeys.children];
            if (children && children.size > 0) {
                this.applyAggregations(rec, children, values, pivotKeys);
                const childRecords = this.collectRecords(children, pivotKeys);
                hierarchy[pivotKeys.aggregations] = this.aggregate(childRecords, values);
                this.applyAggregationRecordData(hierarchy[pivotKeys.aggregations], hierarchy.value, rec, pivotKeys);
            }
            else if (hierarchy[pivotKeys.records]) {
                hierarchy[pivotKeys.aggregations] = this.aggregate(hierarchy[pivotKeys.records], values);
                this.applyAggregationRecordData(hierarchy[pivotKeys.aggregations], hierarchy.value, rec, pivotKeys);
            }
        });
    }
    static applyAggregationRecordData(aggregationData, groupName, rec, pivotKeys) {
        const aggregationKeys = Object.keys(aggregationData);
        if (aggregationKeys.length > 1) {
            aggregationKeys.forEach((key) => {
                const aggregationKey = groupName ? groupName + pivotKeys.columnDimensionSeparator + key : key;
                rec.aggregationValues.set(aggregationKey, aggregationData[key]);
            });
        }
        else if (aggregationKeys.length === 1) {
            const aggregationKey = aggregationKeys[0];
            rec.aggregationValues.set(groupName || aggregationKey, aggregationData[aggregationKey]);
        }
    }
    static aggregate(records, values) {
        const result = {};
        for (const pivotValue of values) {
            const aggregator = PivotUtil.getAggregatorForType(pivotValue.aggregate, pivotValue.dataType);
            if (!aggregator) {
                throw CurrentResourceStrings.GridResStrings.igx_grid_pivot_no_aggregator.replace("{0}", pivotValue.member);
            }
            result[pivotValue.member] = aggregator(records.map(r => r[pivotValue.member]), records);
        }
        return result;
    }
    static getAggregatorForType(aggregate, dataType) {
        let aggregator = aggregate.aggregator;
        if (aggregate.aggregatorName) {
            let aggregators = IgxPivotNumericAggregate.aggregators();
            if (!dataType || dataType === 'date' || dataType === 'dateTime') {
                aggregators = aggregators.concat(IgxPivotDateAggregate.aggregators());
            }
            else if (dataType === 'time') {
                aggregators = aggregators.concat(IgxPivotTimeAggregate.aggregators());
            }
            aggregator = aggregators.find(x => x.key === aggregate.aggregatorName)?.aggregator;
        }
        return aggregator;
    }
    static processHierarchy(hierarchies, pivotKeys, level = 0, rootData = false) {
        const flatData = [];
        hierarchies.forEach((h, key) => {
            const field = h.dimension.memberName;
            const rec = {
                dimensionValues: new Map(),
                aggregationValues: new Map(),
                children: new Map(),
                dimensions: [h.dimension]
            };
            rec.dimensionValues.set(field, key);
            if (h[pivotKeys.records]) {
                rec.records = this.getDirectLeafs(h[pivotKeys.records]);
            }
            rec.level = level;
            flatData.push(rec);
            if (h[pivotKeys.children] && h[pivotKeys.children].size > 0) {
                const nestedData = this.processHierarchy(h[pivotKeys.children], pivotKeys, level + 1, rootData);
                rec.records = this.getDirectLeafs(nestedData);
                rec.children.set(field, nestedData);
            }
        });
        return flatData;
    }
    static getDirectLeafs(records) {
        let leafs = [];
        for (const rec of records) {
            if (rec.records) {
                const data = rec.records.filter(x => !x.records && leafs.indexOf(x) === -1);
                leafs = leafs.concat(data);
            }
            else {
                leafs.push(rec);
            }
        }
        return leafs;
    }
    static getRecordKey(rec, currentDim) {
        const parentFields = [];
        const currentDimIndex = rec.dimensions.findIndex(x => x.memberName === currentDim.memberName) + 1;
        const prevDims = rec.dimensions.slice(0, currentDimIndex);
        for (const prev of prevDims) {
            const prevValue = rec.dimensionValues.get(prev.memberName);
            parentFields.push(prevValue);
        }
        return parentFields.join('-');
    }
    static buildExpressionTree(config) {
        const allDimensions = (config?.rows || []).concat((config?.columns || [])).concat(config?.filters || []).filter(x => x !== null && x !== undefined);
        const enabledDimensions = allDimensions.filter(x => x && x.enabled);
        const expressionsTree = new FilteringExpressionsTree(FilteringLogic.And);
        // add expression trees from all filters
        PivotUtil.flatten(enabledDimensions).forEach((x) => {
            if (x.filter && x.filter.filteringOperands) {
                expressionsTree.filteringOperands.push(...x.filter.filteringOperands);
            }
        });
        return expressionsTree;
    }
    static collectRecords(children, pivotKeys) {
        let result = [];
        children.forEach(value => result = result.concat(value[pivotKeys.records]));
        return result;
    }
    static applyHierarchyChildren(hierarchy, val, rec, pivotKeys) {
        const recordsKey = pivotKeys.records;
        const childKey = pivotKeys.children;
        const childCollection = val[childKey];
        const hierarchyValue = hierarchy.get(val.value);
        if (Array.isArray(hierarchyValue[childKey])) {
            hierarchyValue[childKey] = new Map();
        }
        if (!childCollection || childCollection.size === 0) {
            const dim = hierarchyValue.dimension;
            const isValid = this.extractValueFromDimension(dim, rec) === val.value;
            if (isValid) {
                if (hierarchyValue[recordsKey]) {
                    hierarchyValue[recordsKey].push(rec);
                }
                else {
                    hierarchyValue[recordsKey] = [rec];
                }
            }
        }
        else {
            const hierarchyChild = hierarchyValue[childKey];
            for (const [_key, child] of childCollection) {
                let hierarchyChildValue = hierarchyChild.get(child.value);
                if (!hierarchyChildValue) {
                    hierarchyChild.set(child.value, child);
                    hierarchyChildValue = child;
                }
                if (hierarchyChildValue[recordsKey]) {
                    const copy = Object.assign({}, rec);
                    if (rec[recordsKey]) {
                        // not all nested children are valid
                        const nestedValue = hierarchyChildValue.value;
                        const dimension = hierarchyChildValue.dimension;
                        const validRecs = rec[recordsKey].filter(x => this.extractValueFromDimension(dimension, x) === nestedValue);
                        copy[recordsKey] = validRecs;
                    }
                    hierarchyChildValue[recordsKey].push(copy);
                }
                else {
                    hierarchyChildValue[recordsKey] = [rec];
                }
                if (child[childKey] && child[childKey].size > 0) {
                    this.applyHierarchyChildren(hierarchyChild, child, rec, pivotKeys);
                }
            }
        }
    }
    static getAggregateList(val, grid) {
        if (!val.aggregateList) {
            let defaultAggr = this.getAggregatorsForValue(val, grid);
            const isDefault = defaultAggr.find((x) => x.key === val.aggregate.key);
            // resolve custom aggregations
            if (!isDefault && grid.data[0][val.member] !== undefined) {
                // if field exists, then we can apply default aggregations and add the custom one.
                defaultAggr.unshift(val.aggregate);
            }
            else if (!isDefault) {
                // otherwise this is a custom aggregation that is not compatible
                // with the defaults, since it operates on field that is not in the data
                // leave only the custom one.
                defaultAggr = [val.aggregate];
            }
            val.aggregateList = defaultAggr;
        }
        return val.aggregateList;
    }
    static getAggregatorsForValue(value, grid) {
        const dataType = value.dataType || grid.resolveDataTypes(grid.data[0][value.member]);
        switch (dataType) {
            case GridColumnDataType.Number:
            case GridColumnDataType.Currency:
                return IgxPivotNumericAggregate.aggregators();
            case GridColumnDataType.Date:
            case GridColumnDataType.DateTime:
                return IgxPivotDateAggregate.aggregators();
            case GridColumnDataType.Time:
                return IgxPivotTimeAggregate.aggregators();
            default:
                return IgxPivotAggregate.aggregators();
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGl2b3QtdXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2lnbml0ZXVpLWFuZ3VsYXIvc3JjL2xpYi9ncmlkcy9waXZvdC1ncmlkL3Bpdm90LXV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDbkUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxRQUFRLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUMvRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sc0RBQXNELENBQUM7QUFDdEYsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sa0RBQWtELENBQUM7QUFHNUYsT0FBTyxFQUF3QixVQUFVLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUN0RSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUscUJBQXFCLEVBQUUsd0JBQXdCLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNuSSxPQUFPLEVBQXFHLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFFL0osTUFBTSxPQUFPLFNBQVM7SUFFbEIsa0VBQWtFO0lBQzNELE1BQU0sQ0FBQyxhQUFhLENBQUMsSUFBd0IsRUFBRSxTQUEwQixFQUFFLFNBQXFCO1FBQ25HLEtBQUssTUFBTSxHQUFHLElBQUksSUFBSSxFQUFFO1lBQ3BCLDRCQUE0QjtZQUM1QixJQUFJLEdBQUcsQ0FBQyxRQUFRLElBQUksR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxFQUFFO2dCQUN2Qyw0QkFBNEI7Z0JBQzVCLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7b0JBQzVCLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFLFNBQVMsRUFBRSxT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S0FBa0IsRUFBRSxJQUFtQjtRQUN4RSxNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQ3JGLFFBQVEsUUFBUSxFQUFFO1lBQ2QsS0FBSyxrQkFBa0IsQ0FBQyxNQUFNLENBQUM7WUFDL0IsS0FBSyxrQkFBa0IsQ0FBQyxRQUFRO2dCQUM1QixPQUFPLHdCQUF3QixDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ2xELEtBQUssa0JBQWtCLENBQUMsSUFBSSxDQUFDO1lBQzdCLEtBQUssa0JBQWtCLENBQUMsUUFBUTtnQkFDNUIsT0FBTyxxQkFBcUIsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUMvQyxLQUFLLGtCQUFrQixDQUFDLElBQUk7Z0JBQ3hCLE9BQU8scUJBQXFCLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDL0M7Z0JBQ0ksT0FBTyxpQkFBaUIsQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUM5QztJQUNMLENBQUM7Q0FHSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEN1cnJlbnRSZXNvdXJjZVN0cmluZ3MgfSBmcm9tICcuLi8uLi9jb3JlL2kxOG4vcmVzb3VyY2VzJztcbmltcG9ydCB7IGNsb25lVmFsdWUgfSBmcm9tICcuLi8uLi9jb3JlL3V0aWxzJztcbmltcG9ydCB7IERhdGFVdGlsLCBHcmlkQ29sdW1uRGF0YVR5cGUgfSBmcm9tICcuLi8uLi9kYXRhLW9wZXJhdGlvbnMvZGF0YS11dGlsJztcbmltcG9ydCB7IEZpbHRlcmluZ0xvZ2ljIH0gZnJvbSAnLi4vLi4vZGF0YS1vcGVyYXRpb25zL2ZpbHRlcmluZy1leHByZXNzaW9uLmludGVyZmFjZSc7XG5pbXBvcnQgeyBGaWx0ZXJpbmdFeHByZXNzaW9uc1RyZWUgfSBmcm9tICcuLi8uLi9kYXRhLW9wZXJhdGlvbnMvZmlsdGVyaW5nLWV4cHJlc3Npb25zLXRyZWUnO1xuaW1wb3J0IHsgSVNvcnRpbmdFeHByZXNzaW9uIH0gZnJvbSAnLi4vLi4vZGF0YS1vcGVyYXRpb25zL3NvcnRpbmctc3RyYXRlZ3knO1xuaW1wb3J0IHsgUGl2b3RHcmlkVHlwZSB9IGZyb20gJy4uL2NvbW1vbi9ncmlkLmludGVyZmFjZSc7XG5pbXBvcnQgeyBJR3JpZFNvcnRpbmdTdHJhdGVneSwgSWd4U29ydGluZyB9IGZyb20gJy4uL2NvbW1vbi9zdHJhdGVneSc7XG5pbXBvcnQgeyBJZ3hQaXZvdEFnZ3JlZ2F0ZSwgSWd4UGl2b3REYXRlQWdncmVnYXRlLCBJZ3hQaXZvdE51bWVyaWNBZ2dyZWdhdGUsIElneFBpdm90VGltZUFnZ3JlZ2F0ZSB9IGZyb20gJy4vcGl2b3QtZ3JpZC1hZ2dyZWdhdGUnO1xuaW1wb3J0IHsgSVBpdm90QWdncmVnYXRvciwgSVBpdm90Q29uZmlndXJhdGlvbiwgSVBpdm90RGltZW5zaW9uLCBJUGl2b3RHcmlkUmVjb3JkLCBJUGl2b3RLZXlzLCBJUGl2b3RWYWx1ZSwgUGl2b3REaW1lbnNpb25UeXBlIH0gZnJvbSAnLi9waXZvdC1ncmlkLmludGVyZmFjZSc7XG5cbmV4cG9ydCBjbGFzcyBQaXZvdFV0aWwge1xuXG4gICAgLy8gZ28gdGhyb3VnaCBhbGwgY2hpbGRyZW4gYW5kIGFwcGx5IG5ldyBkaW1lbnNpb24gZ3JvdXBzIGFzIGNoaWxkXG4gICAgcHVibGljIHN0YXRpYyBwcm9jZXNzR3JvdXBzKHJlY3M6IElQaXZvdEdyaWRSZWNvcmRbXSwgZGltZW5zaW9uOiBJUGl2b3REaW1lbnNpb24sIHBpdm90S2V5czogSVBpdm90S2V5cykge1xuICAgICAgICBmb3IgKGNvbnN0IHJlYyBvZiByZWNzKSB7XG4gICAgICAgICAgICAvLyBwcm9jZXNzIGV4aXN0aW5nIGNoaWxkcmVuXG4gICAgICAgICAgICBpZiAocmVjLmNoaWxkcmVuICYmIHJlYy5jaGlsZHJlbi5zaXplID4gMCkge1xuICAgICAgICAgICAgICAgIC8vIHByb2Nlc3MgaGllcmFyY2h5IGluIGRlcHRcbiAgICAgICAgICAgICAgICByZWMuY2hpbGRyZW4uZm9yRWFjaCgodmFsdWVzKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc0dyb3Vwcyh2YWx1ZXMsIGRpbWVuc2lvbiwgcGl2b3RLZXlzKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIGFkZCBjaGlsZHJlbiBmb3IgY3VycmVudCBkaW1lbnNpb25cbiAgICAgICAgICAgIGNvbnN0IGhpZXJhcmNoeUZpZWxkcyA9IFBpdm90VXRpbFxuICAgICAgICAgICAgICAgIC5nZXRGaWVsZHNIaWVyYXJjaHkocmVjLnJlY29yZHMsIFtkaW1lbnNpb25dLCBQaXZvdERpbWVuc2lvblR5cGUuUm93LCBwaXZvdEtleXMpO1xuICAgICAgICAgICAgY29uc3Qgc2libGluZ0RhdGEgPSBQaXZvdFV0aWxcbiAgICAgICAgICAgICAgICAucHJvY2Vzc0hpZXJhcmNoeShoaWVyYXJjaHlGaWVsZHMsIHBpdm90S2V5cywgMCk7XG4gICAgICAgICAgICByZWMuY2hpbGRyZW4uc2V0KGRpbWVuc2lvbi5tZW1iZXJOYW1lLCBzaWJsaW5nRGF0YSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGZsYXR0ZW5Hcm91cHMoZGF0YTogSVBpdm90R3JpZFJlY29yZFtdLCBkaW1lbnNpb246IElQaXZvdERpbWVuc2lvbiwgZXhwYW5zaW9uU3RhdGVzLCBkZWZhdWx0RXhwYW5kOiBib29sZWFuLCBwYXJlbnQ/OiBJUGl2b3REaW1lbnNpb24sIHBhcmVudFJlYz86IElQaXZvdEdyaWRSZWNvcmQpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCByZWMgPSBkYXRhW2ldO1xuICAgICAgICAgICAgY29uc3QgZmllbGQgPSBkaW1lbnNpb24ubWVtYmVyTmFtZTtcbiAgICAgICAgICAgIGlmICghZmllbGQpIHtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IHJlY29yZHNEYXRhID0gcmVjLmNoaWxkcmVuLmdldChmaWVsZCk7XG4gICAgICAgICAgICBpZiAoIXJlY29yZHNEYXRhICYmIHBhcmVudCkge1xuICAgICAgICAgICAgICAgIC8vIGNoZWNrIHBhcmVudFxuICAgICAgICAgICAgICAgIHJlY29yZHNEYXRhID0gcmVjLmNoaWxkcmVuLmdldChwYXJlbnQubWVtYmVyTmFtZSk7XG4gICAgICAgICAgICAgICAgaWYgKHJlY29yZHNEYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgIGRpbWVuc2lvbiA9IHBhcmVudDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChwYXJlbnRSZWMpIHtcbiAgICAgICAgICAgICAgICBwYXJlbnRSZWMuZGltZW5zaW9uVmFsdWVzLmZvckVhY2goKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudC5tZW1iZXJOYW1lICE9PSBrZXkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlYy5kaW1lbnNpb25WYWx1ZXMuc2V0KGtleSwgdmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGltID0gcGFyZW50UmVjLmRpbWVuc2lvbnMuZmluZCh4ID0+IHgubWVtYmVyTmFtZSA9PT0ga2V5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlYy5kaW1lbnNpb25zLnVuc2hpZnQoZGltKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgY29uc3QgZXhwYW5zaW9uUm93S2V5ID0gUGl2b3RVdGlsLmdldFJlY29yZEtleShyZWMsIGRpbWVuc2lvbik7XG4gICAgICAgICAgICBjb25zdCBpc0V4cGFuZGVkID0gZXhwYW5zaW9uU3RhdGVzLmdldChleHBhbnNpb25Sb3dLZXkpID09PSB1bmRlZmluZWQgP1xuICAgICAgICAgICAgICAgIGRlZmF1bHRFeHBhbmQgOlxuICAgICAgICAgICAgICAgIGV4cGFuc2lvblN0YXRlcy5nZXQoZXhwYW5zaW9uUm93S2V5KTtcbiAgICAgICAgICAgIGNvbnN0IHNob3VsZEV4cGFuZCA9IGlzRXhwYW5kZWQgfHwgIWRpbWVuc2lvbi5jaGlsZExldmVsIHx8ICFyZWMuZGltZW5zaW9uVmFsdWVzLmdldChkaW1lbnNpb24ubWVtYmVyTmFtZSk7XG4gICAgICAgICAgICBpZiAoc2hvdWxkRXhwYW5kICYmIHJlY29yZHNEYXRhKSB7XG4gICAgICAgICAgICAgICAgaWYgKGRpbWVuc2lvbi5jaGlsZExldmVsKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmxhdHRlbkdyb3VwcyhyZWNvcmRzRGF0YSwgZGltZW5zaW9uLmNoaWxkTGV2ZWwsIGV4cGFuc2lvblN0YXRlcywgZGVmYXVsdEV4cGFuZCwgZGltZW5zaW9uLCByZWMpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGNvcHkgcGFyZW50IHZhbHVlcyBhbmQgZGltcyBpbiBjaGlsZFxuICAgICAgICAgICAgICAgICAgICByZWNvcmRzRGF0YS5mb3JFYWNoKHggPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVjLmRpbWVuc2lvblZhbHVlcy5mb3JFYWNoKCh2YWx1ZSwga2V5KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpbWVuc2lvbi5tZW1iZXJOYW1lICE9PSBrZXkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeC5kaW1lbnNpb25WYWx1ZXMuc2V0KGtleSwgdmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaW0gPSByZWMuZGltZW5zaW9ucy5maW5kKHkgPT4geS5tZW1iZXJOYW1lID09PSBrZXkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4LmRpbWVuc2lvbnMudW5zaGlmdChkaW0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGRhdGEuc3BsaWNlKGkgKyAxLCAwLCAuLi5yZWNvcmRzRGF0YSk7XG4gICAgICAgICAgICAgICAgaSArPSByZWNvcmRzRGF0YS5sZW5ndGg7XG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBwdWJsaWMgc3RhdGljIGFzc2lnbkxldmVscyhkaW1zKSB7XG4gICAgICAgIGZvciAoY29uc3QgZGltIG9mIGRpbXMpIHtcbiAgICAgICAgICAgIGxldCBjdXJyRGltID0gZGltO1xuICAgICAgICAgICAgbGV0IGx2bCA9IDA7XG4gICAgICAgICAgICB3aGlsZSAoY3VyckRpbS5jaGlsZExldmVsKSB7XG4gICAgICAgICAgICAgICAgY3VyckRpbS5sZXZlbCA9IGx2bDtcbiAgICAgICAgICAgICAgICBjdXJyRGltID0gY3VyckRpbS5jaGlsZExldmVsO1xuICAgICAgICAgICAgICAgIGx2bCsrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY3VyckRpbS5sZXZlbCA9IGx2bDtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwdWJsaWMgc3RhdGljIGdldEZpZWxkc0hpZXJhcmNoeShkYXRhOiBhbnlbXSwgZGltZW5zaW9uczogSVBpdm90RGltZW5zaW9uW10sXG4gICAgICAgIGRpbWVuc2lvblR5cGU6IFBpdm90RGltZW5zaW9uVHlwZSwgcGl2b3RLZXlzOiBJUGl2b3RLZXlzKTogTWFwPHN0cmluZywgYW55PiB7XG4gICAgICAgIGNvbnN0IGhpZXJhcmNoeSA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XG4gICAgICAgIGZvciAoY29uc3QgcmVjIG9mIGRhdGEpIHtcbiAgICAgICAgICAgIGNvbnN0IHZhbHMgPSBkaW1lbnNpb25UeXBlID09PSBQaXZvdERpbWVuc2lvblR5cGUuQ29sdW1uID9cbiAgICAgICAgICAgICAgICB0aGlzLmV4dHJhY3RWYWx1ZXNGb3JDb2x1bW4oZGltZW5zaW9ucywgcmVjLCBwaXZvdEtleXMpIDpcbiAgICAgICAgICAgICAgICB0aGlzLmV4dHJhY3RWYWx1ZXNGb3JSb3coZGltZW5zaW9ucywgcmVjLCBwaXZvdEtleXMpO1xuICAgICAgICAgICAgZm9yIChjb25zdCBbX2tleSwgdmFsXSBvZiB2YWxzKSB7IC8vIHRoaXMgc2hvdWxkIGdvIGluIGRlcHRoIGFsc28gdmFscy5jaGlsZHJlblxuICAgICAgICAgICAgICAgIGlmIChoaWVyYXJjaHkuZ2V0KHZhbC52YWx1ZSkgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5SGllcmFyY2h5Q2hpbGRyZW4oaGllcmFyY2h5LCB2YWwsIHJlYywgcGl2b3RLZXlzKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBoaWVyYXJjaHkuc2V0KHZhbC52YWx1ZSwgY2xvbmVWYWx1ZSh2YWwpKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBseUhpZXJhcmNoeUNoaWxkcmVuKGhpZXJhcmNoeSwgdmFsLCByZWMsIHBpdm90S2V5cyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBoaWVyYXJjaHk7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBzb3J0KGRhdGE6IElQaXZvdEdyaWRSZWNvcmRbXSwgZXhwcmVzc2lvbnM6IElTb3J0aW5nRXhwcmVzc2lvbltdLCBzb3J0aW5nOiBJR3JpZFNvcnRpbmdTdHJhdGVneSA9IG5ldyBJZ3hTb3J0aW5nKCkpOiBhbnlbXSB7XG4gICAgICAgIGRhdGEuZm9yRWFjaChyZWMgPT4ge1xuICAgICAgICAgICAgY29uc3QgY2hpbGRyZW4gPSByZWMuY2hpbGRyZW47XG4gICAgICAgICAgICBpZiAoY2hpbGRyZW4pIHtcbiAgICAgICAgICAgICAgICBjaGlsZHJlbi5mb3JFYWNoKHggPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNvcnQoeCwgZXhwcmVzc2lvbnMsIHNvcnRpbmcpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIERhdGFVdGlsLnNvcnQoZGF0YSwgZXhwcmVzc2lvbnMsIHNvcnRpbmcpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZXh0cmFjdFZhbHVlRnJvbURpbWVuc2lvbihkaW06IElQaXZvdERpbWVuc2lvbiwgcmVjRGF0YTogYW55KSB7XG4gICAgICAgIHJldHVybiBkaW0ubWVtYmVyRnVuY3Rpb24gPyBkaW0ubWVtYmVyRnVuY3Rpb24uY2FsbChudWxsLCByZWNEYXRhKSA6IHJlY0RhdGFbZGltLm1lbWJlck5hbWVdO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0RGltZW5zaW9uRGVwdGgoZGltOiBJUGl2b3REaW1lbnNpb24pOiBudW1iZXIge1xuICAgICAgICBsZXQgbHZsID0gMDtcbiAgICAgICAgd2hpbGUgKGRpbS5jaGlsZExldmVsKSB7XG4gICAgICAgICAgICBsdmwrKztcbiAgICAgICAgICAgIGRpbSA9IGRpbS5jaGlsZExldmVsO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBsdmw7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBleHRyYWN0VmFsdWVzRm9yUm93KGRpbXM6IElQaXZvdERpbWVuc2lvbltdLCByZWNEYXRhOiBhbnksIHBpdm90S2V5czogSVBpdm90S2V5cykge1xuICAgICAgICBjb25zdCB2YWx1ZXMgPSBuZXcgTWFwPHN0cmluZywgYW55PigpO1xuICAgICAgICBmb3IgKGNvbnN0IGNvbCBvZiBkaW1zKSB7XG4gICAgICAgICAgICBpZiAocmVjRGF0YVtwaXZvdEtleXMubGV2ZWxdICYmIHJlY0RhdGFbcGl2b3RLZXlzLmxldmVsXSA+IDApIHtcbiAgICAgICAgICAgICAgICBjb25zdCBjaGlsZERhdGEgPSByZWNEYXRhW3Bpdm90S2V5cy5yZWNvcmRzXTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRGaWVsZHNIaWVyYXJjaHkoY2hpbGREYXRhLCBbY29sXSwgUGl2b3REaW1lbnNpb25UeXBlLlJvdywgcGl2b3RLZXlzKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmV4dHJhY3RWYWx1ZUZyb21EaW1lbnNpb24oY29sLCByZWNEYXRhKTtcbiAgICAgICAgICAgIGNvbnN0IG9ialZhbHVlID0ge307XG4gICAgICAgICAgICBvYmpWYWx1ZVsndmFsdWUnXSA9IHZhbHVlO1xuICAgICAgICAgICAgb2JqVmFsdWVbJ2RpbWVuc2lvbiddID0gY29sO1xuICAgICAgICAgICAgaWYgKGNvbC5jaGlsZExldmVsKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2hpbGRWYWx1ZXMgPSB0aGlzLmV4dHJhY3RWYWx1ZXNGb3JSb3coW2NvbC5jaGlsZExldmVsXSwgcmVjRGF0YSwgcGl2b3RLZXlzKTtcbiAgICAgICAgICAgICAgICBvYmpWYWx1ZVtwaXZvdEtleXMuY2hpbGRyZW5dID0gY2hpbGRWYWx1ZXM7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YWx1ZXMuc2V0KHZhbHVlLCBvYmpWYWx1ZSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdmFsdWVzO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZXh0cmFjdFZhbHVlc0ZvckNvbHVtbihkaW1zOiBJUGl2b3REaW1lbnNpb25bXSwgcmVjRGF0YTogYW55LCBwaXZvdEtleXM6IElQaXZvdEtleXMsIHBhdGggPSBbXSkge1xuICAgICAgICBjb25zdCB2YWxzID0gbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcbiAgICAgICAgbGV0IGx2bENvbGxlY3Rpb24gPSB2YWxzO1xuICAgICAgICBjb25zdCBmbGF0dGVuZWREaW1zID0gdGhpcy5mbGF0dGVuKGRpbXMpO1xuICAgICAgICBmb3IgKGNvbnN0IGNvbCBvZiBmbGF0dGVuZWREaW1zKSB7XG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuZXh0cmFjdFZhbHVlRnJvbURpbWVuc2lvbihjb2wsIHJlY0RhdGEpO1xuICAgICAgICAgICAgcGF0aC5wdXNoKHZhbHVlKTtcbiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gcGF0aC5qb2luKHBpdm90S2V5cy5jb2x1bW5EaW1lbnNpb25TZXBhcmF0b3IpO1xuICAgICAgICAgICAgY29uc3QgbmV3T2JqID0geyB2YWx1ZTogbmV3VmFsdWUsIGV4cGFuZGFibGU6IGNvbC5leHBhbmRhYmxlLCBjaGlsZHJlbjogbnVsbCwgZGltZW5zaW9uOiBjb2wgfTtcbiAgICAgICAgICAgIGlmICghbmV3T2JqLmNoaWxkcmVuKSB7XG4gICAgICAgICAgICAgICAgbmV3T2JqLmNoaWxkcmVuID0gbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGx2bENvbGxlY3Rpb24uc2V0KG5ld1ZhbHVlLCBuZXdPYmopO1xuICAgICAgICAgICAgbHZsQ29sbGVjdGlvbiA9IG5ld09iai5jaGlsZHJlbjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdmFscztcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGZsYXR0ZW4oYXJyLCBsdmwgPSAwKSB7XG4gICAgICAgIGNvbnN0IG5ld0FyciA9IGFyci5yZWR1Y2UoKGFjYywgaXRlbSkgPT4ge1xuICAgICAgICAgICAgaXRlbS5sZXZlbCA9IGx2bDtcbiAgICAgICAgICAgIGFjYy5wdXNoKGl0ZW0pO1xuICAgICAgICAgICAgaWYgKGl0ZW0uY2hpbGRMZXZlbCkge1xuICAgICAgICAgICAgICAgIGl0ZW0uZXhwYW5kYWJsZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgYWNjID0gYWNjLmNvbmNhdCh0aGlzLmZsYXR0ZW4oW2l0ZW0uY2hpbGRMZXZlbF0sIGx2bCArIDEpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBhY2M7XG4gICAgICAgIH0sIFtdKTtcbiAgICAgICAgcmV0dXJuIG5ld0FycjtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGFwcGx5QWdncmVnYXRpb25zKHJlYzogSVBpdm90R3JpZFJlY29yZCwgaGllcmFyY2hpZXMsIHZhbHVlcywgcGl2b3RLZXlzOiBJUGl2b3RLZXlzKSB7XG4gICAgICAgIGlmIChoaWVyYXJjaGllcy5zaXplID09PSAwKSB7XG4gICAgICAgICAgICAvLyBubyBjb2x1bW4gZ3JvdXBzXG4gICAgICAgICAgICBjb25zdCBhZ2dyZWdhdGlvblJlc3VsdCA9IHRoaXMuYWdncmVnYXRlKHJlYy5yZWNvcmRzLCB2YWx1ZXMpO1xuICAgICAgICAgICAgdGhpcy5hcHBseUFnZ3JlZ2F0aW9uUmVjb3JkRGF0YShhZ2dyZWdhdGlvblJlc3VsdCwgdW5kZWZpbmVkLCByZWMsIHBpdm90S2V5cyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaGllcmFyY2hpZXMuZm9yRWFjaCgoaGllcmFyY2h5KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjaGlsZHJlbiA9IGhpZXJhcmNoeVtwaXZvdEtleXMuY2hpbGRyZW5dO1xuICAgICAgICAgICAgaWYgKGNoaWxkcmVuICYmIGNoaWxkcmVuLnNpemUgPiAwKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcHBseUFnZ3JlZ2F0aW9ucyhyZWMsIGNoaWxkcmVuLCB2YWx1ZXMsIHBpdm90S2V5cyk7XG4gICAgICAgICAgICAgICAgY29uc3QgY2hpbGRSZWNvcmRzID0gdGhpcy5jb2xsZWN0UmVjb3JkcyhjaGlsZHJlbiwgcGl2b3RLZXlzKTtcbiAgICAgICAgICAgICAgICBoaWVyYXJjaHlbcGl2b3RLZXlzLmFnZ3JlZ2F0aW9uc10gPSB0aGlzLmFnZ3JlZ2F0ZShjaGlsZFJlY29yZHMsIHZhbHVlcyk7XG4gICAgICAgICAgICAgICAgdGhpcy5hcHBseUFnZ3JlZ2F0aW9uUmVjb3JkRGF0YShoaWVyYXJjaHlbcGl2b3RLZXlzLmFnZ3JlZ2F0aW9uc10sIGhpZXJhcmNoeS52YWx1ZSwgcmVjLCBwaXZvdEtleXMpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChoaWVyYXJjaHlbcGl2b3RLZXlzLnJlY29yZHNdKSB7XG4gICAgICAgICAgICAgICAgaGllcmFyY2h5W3Bpdm90S2V5cy5hZ2dyZWdhdGlvbnNdID0gdGhpcy5hZ2dyZWdhdGUoaGllcmFyY2h5W3Bpdm90S2V5cy5yZWNvcmRzXSwgdmFsdWVzKTtcbiAgICAgICAgICAgICAgICB0aGlzLmFwcGx5QWdncmVnYXRpb25SZWNvcmREYXRhKGhpZXJhcmNoeVtwaXZvdEtleXMuYWdncmVnYXRpb25zXSwgaGllcmFyY2h5LnZhbHVlLCByZWMsIHBpdm90S2V5cyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBzdGF0aWMgYXBwbHlBZ2dyZWdhdGlvblJlY29yZERhdGEoYWdncmVnYXRpb25EYXRhOiBhbnksIGdyb3VwTmFtZTogc3RyaW5nLCByZWM6IElQaXZvdEdyaWRSZWNvcmQsIHBpdm90S2V5czogSVBpdm90S2V5cykge1xuICAgICAgICBjb25zdCBhZ2dyZWdhdGlvbktleXMgPSBPYmplY3Qua2V5cyhhZ2dyZWdhdGlvbkRhdGEpO1xuICAgICAgICBpZiAoYWdncmVnYXRpb25LZXlzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgIGFnZ3JlZ2F0aW9uS2V5cy5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBhZ2dyZWdhdGlvbktleSA9IGdyb3VwTmFtZSA/IGdyb3VwTmFtZSArIHBpdm90S2V5cy5jb2x1bW5EaW1lbnNpb25TZXBhcmF0b3IgKyBrZXkgOiBrZXk7XG4gICAgICAgICAgICAgICAgcmVjLmFnZ3JlZ2F0aW9uVmFsdWVzLnNldChhZ2dyZWdhdGlvbktleSwgYWdncmVnYXRpb25EYXRhW2tleV0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSAgaWYgKGFnZ3JlZ2F0aW9uS2V5cy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgIGNvbnN0IGFnZ3JlZ2F0aW9uS2V5ID0gYWdncmVnYXRpb25LZXlzWzBdO1xuICAgICAgICAgICAgcmVjLmFnZ3JlZ2F0aW9uVmFsdWVzLnNldChncm91cE5hbWUgfHwgYWdncmVnYXRpb25LZXksIGFnZ3JlZ2F0aW9uRGF0YVthZ2dyZWdhdGlvbktleV0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBhZ2dyZWdhdGUocmVjb3JkcywgdmFsdWVzOiBJUGl2b3RWYWx1ZVtdKSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgICAgICBmb3IgKGNvbnN0IHBpdm90VmFsdWUgb2YgdmFsdWVzKSB7XG4gICAgICAgICAgICBjb25zdCBhZ2dyZWdhdG9yID0gUGl2b3RVdGlsLmdldEFnZ3JlZ2F0b3JGb3JUeXBlKHBpdm90VmFsdWUuYWdncmVnYXRlLCBwaXZvdFZhbHVlLmRhdGFUeXBlKTtcbiAgICAgICAgICAgIGlmICghYWdncmVnYXRvcikge1xuICAgICAgICAgICAgICAgIHRocm93IEN1cnJlbnRSZXNvdXJjZVN0cmluZ3MuR3JpZFJlc1N0cmluZ3MuaWd4X2dyaWRfcGl2b3Rfbm9fYWdncmVnYXRvci5yZXBsYWNlKFwiezB9XCIsIHBpdm90VmFsdWUubWVtYmVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJlc3VsdFtwaXZvdFZhbHVlLm1lbWJlcl0gPSBhZ2dyZWdhdG9yKHJlY29yZHMubWFwKHIgPT4gcltwaXZvdFZhbHVlLm1lbWJlcl0pLCByZWNvcmRzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBnZXRBZ2dyZWdhdG9yRm9yVHlwZShhZ2dyZWdhdGU6IElQaXZvdEFnZ3JlZ2F0b3IsIGRhdGFUeXBlOiBHcmlkQ29sdW1uRGF0YVR5cGUpIHtcbiAgICAgICAgbGV0IGFnZ3JlZ2F0b3IgPSBhZ2dyZWdhdGUuYWdncmVnYXRvcjtcbiAgICAgICAgaWYgKGFnZ3JlZ2F0ZS5hZ2dyZWdhdG9yTmFtZSkge1xuICAgICAgICAgICAgbGV0IGFnZ3JlZ2F0b3JzID0gSWd4UGl2b3ROdW1lcmljQWdncmVnYXRlLmFnZ3JlZ2F0b3JzKCk7XG4gICAgICAgICAgICBpZiAoIWRhdGFUeXBlIHx8IGRhdGFUeXBlID09PSAnZGF0ZScgfHwgZGF0YVR5cGUgPT09ICdkYXRlVGltZScpIHtcbiAgICAgICAgICAgICAgICBhZ2dyZWdhdG9ycyA9IGFnZ3JlZ2F0b3JzLmNvbmNhdChJZ3hQaXZvdERhdGVBZ2dyZWdhdGUuYWdncmVnYXRvcnMoKSlcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YVR5cGUgPT09ICd0aW1lJykge1xuICAgICAgICAgICAgICAgIGFnZ3JlZ2F0b3JzID0gYWdncmVnYXRvcnMuY29uY2F0KElneFBpdm90VGltZUFnZ3JlZ2F0ZS5hZ2dyZWdhdG9ycygpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGFnZ3JlZ2F0b3IgPSBhZ2dyZWdhdG9ycy5maW5kKHggPT4geC5rZXkgPT09IGFnZ3JlZ2F0ZS5hZ2dyZWdhdG9yTmFtZSk/LmFnZ3JlZ2F0b3I7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFnZ3JlZ2F0b3I7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBwcm9jZXNzSGllcmFyY2h5KGhpZXJhcmNoaWVzLCBwaXZvdEtleXMsIGxldmVsID0gMCwgcm9vdERhdGEgPSBmYWxzZSk6IElQaXZvdEdyaWRSZWNvcmRbXSB7XG4gICAgICAgIGNvbnN0IGZsYXREYXRhOiBJUGl2b3RHcmlkUmVjb3JkW10gPSBbXTtcbiAgICAgICAgaGllcmFyY2hpZXMuZm9yRWFjaCgoaCwga2V5KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBmaWVsZCA9IGguZGltZW5zaW9uLm1lbWJlck5hbWU7XG4gICAgICAgICAgICBjb25zdCByZWM6IElQaXZvdEdyaWRSZWNvcmQgPSB7XG4gICAgICAgICAgICAgICAgZGltZW5zaW9uVmFsdWVzOiBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpLFxuICAgICAgICAgICAgICAgIGFnZ3JlZ2F0aW9uVmFsdWVzOiBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpLFxuICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBuZXcgTWFwPHN0cmluZywgSVBpdm90R3JpZFJlY29yZFtdPigpLFxuICAgICAgICAgICAgICAgIGRpbWVuc2lvbnM6IFtoLmRpbWVuc2lvbl1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICByZWMuZGltZW5zaW9uVmFsdWVzLnNldChmaWVsZCwga2V5KTtcbiAgICAgICAgICAgIGlmIChoW3Bpdm90S2V5cy5yZWNvcmRzXSkge1xuICAgICAgICAgICAgICAgIHJlYy5yZWNvcmRzID0gdGhpcy5nZXREaXJlY3RMZWFmcyhoW3Bpdm90S2V5cy5yZWNvcmRzXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZWMubGV2ZWwgPSBsZXZlbDtcbiAgICAgICAgICAgIGZsYXREYXRhLnB1c2gocmVjKTtcbiAgICAgICAgICAgIGlmIChoW3Bpdm90S2V5cy5jaGlsZHJlbl0gJiYgaFtwaXZvdEtleXMuY2hpbGRyZW5dLnNpemUgPiAwKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbmVzdGVkRGF0YSA9IHRoaXMucHJvY2Vzc0hpZXJhcmNoeShoW3Bpdm90S2V5cy5jaGlsZHJlbl0sXG4gICAgICAgICAgICAgICAgICAgIHBpdm90S2V5cywgbGV2ZWwgKyAxLCByb290RGF0YSk7XG4gICAgICAgICAgICAgICAgcmVjLnJlY29yZHMgPSB0aGlzLmdldERpcmVjdExlYWZzKG5lc3RlZERhdGEpO1xuICAgICAgICAgICAgICAgIHJlYy5jaGlsZHJlbi5zZXQoZmllbGQsIG5lc3RlZERhdGEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gZmxhdERhdGE7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBnZXREaXJlY3RMZWFmcyhyZWNvcmRzOiBJUGl2b3RHcmlkUmVjb3JkW10pIHtcbiAgICAgICAgbGV0IGxlYWZzID0gW107XG4gICAgICAgIGZvciAoY29uc3QgcmVjIG9mIHJlY29yZHMpIHtcbiAgICAgICAgICAgIGlmIChyZWMucmVjb3Jkcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSByZWMucmVjb3Jkcy5maWx0ZXIoeCA9PiAheC5yZWNvcmRzICYmIGxlYWZzLmluZGV4T2YoeCkgPT09IC0xKTtcbiAgICAgICAgICAgICAgICBsZWFmcyA9IGxlYWZzLmNvbmNhdChkYXRhKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbGVhZnMucHVzaChyZWMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBsZWFmcztcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGdldFJlY29yZEtleShyZWM6IElQaXZvdEdyaWRSZWNvcmQsIGN1cnJlbnREaW06IElQaXZvdERpbWVuc2lvbiwpIHtcbiAgICAgICAgY29uc3QgcGFyZW50RmllbGRzID0gW107XG4gICAgICAgIGNvbnN0IGN1cnJlbnREaW1JbmRleCA9IHJlYy5kaW1lbnNpb25zLmZpbmRJbmRleCh4ID0+IHgubWVtYmVyTmFtZSA9PT0gY3VycmVudERpbS5tZW1iZXJOYW1lKSArIDE7XG4gICAgICAgIGNvbnN0IHByZXZEaW1zID0gcmVjLmRpbWVuc2lvbnMuc2xpY2UoMCwgY3VycmVudERpbUluZGV4KTtcbiAgICAgICAgZm9yIChjb25zdCBwcmV2IG9mIHByZXZEaW1zKSB7XG4gICAgICAgICAgICBjb25zdCBwcmV2VmFsdWUgPSByZWMuZGltZW5zaW9uVmFsdWVzLmdldChwcmV2Lm1lbWJlck5hbWUpO1xuICAgICAgICAgICAgcGFyZW50RmllbGRzLnB1c2gocHJldlZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcGFyZW50RmllbGRzLmpvaW4oJy0nKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGJ1aWxkRXhwcmVzc2lvblRyZWUoY29uZmlnOiBJUGl2b3RDb25maWd1cmF0aW9uKSB7XG4gICAgICAgIGNvbnN0IGFsbERpbWVuc2lvbnMgPSAoY29uZmlnPy5yb3dzIHx8IFtdKS5jb25jYXQoKGNvbmZpZz8uY29sdW1ucyB8fCBbXSkpLmNvbmNhdChjb25maWc/LmZpbHRlcnMgfHwgW10pLmZpbHRlcih4ID0+IHggIT09IG51bGwgJiYgeCAhPT0gdW5kZWZpbmVkKTtcbiAgICAgICAgY29uc3QgZW5hYmxlZERpbWVuc2lvbnMgPSBhbGxEaW1lbnNpb25zLmZpbHRlcih4ID0+IHggJiYgeC5lbmFibGVkKTtcblxuICAgICAgICBjb25zdCBleHByZXNzaW9uc1RyZWUgPSBuZXcgRmlsdGVyaW5nRXhwcmVzc2lvbnNUcmVlKEZpbHRlcmluZ0xvZ2ljLkFuZCk7XG4gICAgICAgIC8vIGFkZCBleHByZXNzaW9uIHRyZWVzIGZyb20gYWxsIGZpbHRlcnNcbiAgICAgICAgUGl2b3RVdGlsLmZsYXR0ZW4oZW5hYmxlZERpbWVuc2lvbnMpLmZvckVhY2goKHg6IElQaXZvdERpbWVuc2lvbikgPT4ge1xuICAgICAgICAgICAgaWYgKHguZmlsdGVyICYmIHguZmlsdGVyLmZpbHRlcmluZ09wZXJhbmRzKSB7XG4gICAgICAgICAgICAgICAgZXhwcmVzc2lvbnNUcmVlLmZpbHRlcmluZ09wZXJhbmRzLnB1c2goLi4ueC5maWx0ZXIuZmlsdGVyaW5nT3BlcmFuZHMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gZXhwcmVzc2lvbnNUcmVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIGNvbGxlY3RSZWNvcmRzKGNoaWxkcmVuLCBwaXZvdEtleXM6IElQaXZvdEtleXMpIHtcbiAgICAgICAgbGV0IHJlc3VsdCA9IFtdO1xuICAgICAgICBjaGlsZHJlbi5mb3JFYWNoKHZhbHVlID0+IHJlc3VsdCA9IHJlc3VsdC5jb25jYXQodmFsdWVbcGl2b3RLZXlzLnJlY29yZHNdKSk7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgYXBwbHlIaWVyYXJjaHlDaGlsZHJlbihoaWVyYXJjaHksIHZhbCwgcmVjLCBwaXZvdEtleXM6IElQaXZvdEtleXMpIHtcbiAgICAgICAgY29uc3QgcmVjb3Jkc0tleSA9IHBpdm90S2V5cy5yZWNvcmRzO1xuICAgICAgICBjb25zdCBjaGlsZEtleSA9IHBpdm90S2V5cy5jaGlsZHJlbjtcbiAgICAgICAgY29uc3QgY2hpbGRDb2xsZWN0aW9uID0gdmFsW2NoaWxkS2V5XTtcbiAgICAgICAgY29uc3QgaGllcmFyY2h5VmFsdWUgPSBoaWVyYXJjaHkuZ2V0KHZhbC52YWx1ZSk7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KGhpZXJhcmNoeVZhbHVlW2NoaWxkS2V5XSkpIHtcbiAgICAgICAgICAgIGhpZXJhcmNoeVZhbHVlW2NoaWxkS2V5XSA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFjaGlsZENvbGxlY3Rpb24gfHwgY2hpbGRDb2xsZWN0aW9uLnNpemUgPT09IDApIHtcbiAgICAgICAgICAgIGNvbnN0IGRpbSA9IGhpZXJhcmNoeVZhbHVlLmRpbWVuc2lvbjtcbiAgICAgICAgICAgIGNvbnN0IGlzVmFsaWQgPSB0aGlzLmV4dHJhY3RWYWx1ZUZyb21EaW1lbnNpb24oZGltLCByZWMpID09PSB2YWwudmFsdWU7XG4gICAgICAgICAgICBpZiAoaXNWYWxpZCkge1xuICAgICAgICAgICAgICAgIGlmIChoaWVyYXJjaHlWYWx1ZVtyZWNvcmRzS2V5XSkge1xuICAgICAgICAgICAgICAgICAgICBoaWVyYXJjaHlWYWx1ZVtyZWNvcmRzS2V5XS5wdXNoKHJlYyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaGllcmFyY2h5VmFsdWVbcmVjb3Jkc0tleV0gPSBbcmVjXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBoaWVyYXJjaHlDaGlsZCA9IGhpZXJhcmNoeVZhbHVlW2NoaWxkS2V5XTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgW19rZXksIGNoaWxkXSBvZiBjaGlsZENvbGxlY3Rpb24pIHtcbiAgICAgICAgICAgICAgICBsZXQgaGllcmFyY2h5Q2hpbGRWYWx1ZSA9IGhpZXJhcmNoeUNoaWxkLmdldChjaGlsZC52YWx1ZSk7XG4gICAgICAgICAgICAgICAgaWYgKCFoaWVyYXJjaHlDaGlsZFZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgIGhpZXJhcmNoeUNoaWxkLnNldChjaGlsZC52YWx1ZSwgY2hpbGQpO1xuICAgICAgICAgICAgICAgICAgICBoaWVyYXJjaHlDaGlsZFZhbHVlID0gY2hpbGQ7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGhpZXJhcmNoeUNoaWxkVmFsdWVbcmVjb3Jkc0tleV0pIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29weSA9IE9iamVjdC5hc3NpZ24oe30sIHJlYyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZWNbcmVjb3Jkc0tleV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5vdCBhbGwgbmVzdGVkIGNoaWxkcmVuIGFyZSB2YWxpZFxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmVzdGVkVmFsdWUgPSBoaWVyYXJjaHlDaGlsZFZhbHVlLnZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGltZW5zaW9uID0gaGllcmFyY2h5Q2hpbGRWYWx1ZS5kaW1lbnNpb247XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWxpZFJlY3MgPSByZWNbcmVjb3Jkc0tleV0uZmlsdGVyKHggPT4gdGhpcy5leHRyYWN0VmFsdWVGcm9tRGltZW5zaW9uKGRpbWVuc2lvbiwgeCkgPT09IG5lc3RlZFZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvcHlbcmVjb3Jkc0tleV0gPSB2YWxpZFJlY3M7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaGllcmFyY2h5Q2hpbGRWYWx1ZVtyZWNvcmRzS2V5XS5wdXNoKGNvcHkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGhpZXJhcmNoeUNoaWxkVmFsdWVbcmVjb3Jkc0tleV0gPSBbcmVjXTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoY2hpbGRbY2hpbGRLZXldICYmIGNoaWxkW2NoaWxkS2V5XS5zaXplID4gMCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGx5SGllcmFyY2h5Q2hpbGRyZW4oaGllcmFyY2h5Q2hpbGQsIGNoaWxkLCByZWMsIHBpdm90S2V5cyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBnZXRBZ2dyZWdhdGVMaXN0KHZhbDogSVBpdm90VmFsdWUsIGdyaWQ6IFBpdm90R3JpZFR5cGUpOiBJUGl2b3RBZ2dyZWdhdG9yW10ge1xuICAgICAgICBpZiAoIXZhbC5hZ2dyZWdhdGVMaXN0KSB7XG4gICAgICAgICAgICBsZXQgZGVmYXVsdEFnZ3IgPSB0aGlzLmdldEFnZ3JlZ2F0b3JzRm9yVmFsdWUodmFsLCBncmlkKTtcbiAgICAgICAgICAgIGNvbnN0IGlzRGVmYXVsdCA9IGRlZmF1bHRBZ2dyLmZpbmQoXG4gICAgICAgICAgICAgICAgKHgpID0+IHgua2V5ID09PSB2YWwuYWdncmVnYXRlLmtleVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIC8vIHJlc29sdmUgY3VzdG9tIGFnZ3JlZ2F0aW9uc1xuICAgICAgICAgICAgaWYgKCFpc0RlZmF1bHQgJiYgZ3JpZC5kYXRhWzBdW3ZhbC5tZW1iZXJdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAvLyBpZiBmaWVsZCBleGlzdHMsIHRoZW4gd2UgY2FuIGFwcGx5IGRlZmF1bHQgYWdncmVnYXRpb25zIGFuZCBhZGQgdGhlIGN1c3RvbSBvbmUuXG4gICAgICAgICAgICAgICAgZGVmYXVsdEFnZ3IudW5zaGlmdCh2YWwuYWdncmVnYXRlKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWlzRGVmYXVsdCkge1xuICAgICAgICAgICAgICAgIC8vIG90aGVyd2lzZSB0aGlzIGlzIGEgY3VzdG9tIGFnZ3JlZ2F0aW9uIHRoYXQgaXMgbm90IGNvbXBhdGlibGVcbiAgICAgICAgICAgICAgICAvLyB3aXRoIHRoZSBkZWZhdWx0cywgc2luY2UgaXQgb3BlcmF0ZXMgb24gZmllbGQgdGhhdCBpcyBub3QgaW4gdGhlIGRhdGFcbiAgICAgICAgICAgICAgICAvLyBsZWF2ZSBvbmx5IHRoZSBjdXN0b20gb25lLlxuICAgICAgICAgICAgICAgIGRlZmF1bHRBZ2dyID0gW3ZhbC5hZ2dyZWdhdGVdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFsLmFnZ3JlZ2F0ZUxpc3QgPSBkZWZhdWx0QWdncjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdmFsLmFnZ3JlZ2F0ZUxpc3Q7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBnZXRBZ2dyZWdhdG9yc0ZvclZhbHVlKHZhbHVlOiBJUGl2b3RWYWx1ZSwgZ3JpZDogUGl2b3RHcmlkVHlwZSk6IElQaXZvdEFnZ3JlZ2F0b3JbXSB7XG4gICAgICAgIGNvbnN0IGRhdGFUeXBlID0gdmFsdWUuZGF0YVR5cGUgfHwgZ3JpZC5yZXNvbHZlRGF0YVR5cGVzKGdyaWQuZGF0YVswXVt2YWx1ZS5tZW1iZXJdKTtcbiAgICAgICAgc3dpdGNoIChkYXRhVHlwZSkge1xuICAgICAgICAgICAgY2FzZSBHcmlkQ29sdW1uRGF0YVR5cGUuTnVtYmVyOlxuICAgICAgICAgICAgY2FzZSBHcmlkQ29sdW1uRGF0YVR5cGUuQ3VycmVuY3k6XG4gICAgICAgICAgICAgICAgcmV0dXJuIElneFBpdm90TnVtZXJpY0FnZ3JlZ2F0ZS5hZ2dyZWdhdG9ycygpO1xuICAgICAgICAgICAgY2FzZSBHcmlkQ29sdW1uRGF0YVR5cGUuRGF0ZTpcbiAgICAgICAgICAgIGNhc2UgR3JpZENvbHVtbkRhdGFUeXBlLkRhdGVUaW1lOlxuICAgICAgICAgICAgICAgIHJldHVybiBJZ3hQaXZvdERhdGVBZ2dyZWdhdGUuYWdncmVnYXRvcnMoKTtcbiAgICAgICAgICAgIGNhc2UgR3JpZENvbHVtbkRhdGFUeXBlLlRpbWU6XG4gICAgICAgICAgICAgICAgcmV0dXJuIElneFBpdm90VGltZUFnZ3JlZ2F0ZS5hZ2dyZWdhdG9ycygpO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICByZXR1cm4gSWd4UGl2b3RBZ2dyZWdhdGUuYWdncmVnYXRvcnMoKTtcbiAgICAgICAgfVxuICAgIH1cblxuXG59XG4iXX0=