import { HeaderType, ExportRecordType } from '../exporter-common/base-export-service';
import { ExportUtilities } from '../exporter-common/export-utilities';
import { WorksheetDataDictionary } from './worksheet-data-dictionary';
/** @hidden */
export class WorksheetData {
    constructor(_data, options, sort, columnCount, rootKeys, indexOfLastPinnedColumn, columnWidths, owner, owners) {
        this._data = _data;
        this.options = options;
        this.sort = sort;
        this.columnCount = columnCount;
        this.rootKeys = rootKeys;
        this.indexOfLastPinnedColumn = indexOfLastPinnedColumn;
        this.columnWidths = columnWidths;
        this.owner = owner;
        this.owners = owners;
        this.initializeData();
    }
    get data() {
        return this._data;
    }
    get rowCount() {
        return this._rowCount;
    }
    get isEmpty() {
        return !this.rowCount
            || this.rowCount === this.owner.maxLevel + 1
            || !this.columnCount
            || this.owner.columns.every(c => c.skip);
    }
    get isSpecialData() {
        return this._isSpecialData;
    }
    get dataDictionary() {
        return this._dataDictionary;
    }
    get hasMultiColumnHeader() {
        return this._hasMultiColumnHeader;
    }
    get hasSummaries() {
        return this._hasSummaries;
    }
    get hasMultiRowHeader() {
        return this._hasMultiRowHeader;
    }
    get isHierarchical() {
        return this._isHierarchical;
    }
    get isTreeGrid() {
        return this._isTreeGrid;
    }
    get isPivotGrid() {
        return this._isPivotGrid;
    }
    get isGroupedGrid() {
        return this._data.some(d => d.type === ExportRecordType.GroupedRecord);
    }
    get maxLevel() {
        return [...new Set(this._data.map(item => item.level))].sort((a, b) => (a > b ? -1 : 1))[0];
    }
    get multiColumnHeaderRows() {
        return !this.options.ignoreMultiColumnHeaders ? Array.from(this.owners.values()).map(c => c.maxLevel).reduce((a, b) => a + b) : 0;
    }
    initializeData() {
        this._dataDictionary = new WorksheetDataDictionary(this.columnCount, this.options.columnWidth, this.columnWidths);
        this._hasMultiColumnHeader = Array.from(this.owners.values())
            .some(o => o.columns.some(col => !col.skip && col.headerType === HeaderType.MultiColumnHeader));
        this._hasMultiRowHeader = Array.from(this.owners.values())
            .some(o => o.columns.some(col => !col.skip && col.headerType === HeaderType.MultiRowHeader));
        this._isHierarchical = this.data[0]?.type === ExportRecordType.HierarchicalGridRecord
            || !(typeof (Array.from(this.owners.keys())[0]) === 'string');
        this._hasSummaries = this._data.filter(d => d.type === ExportRecordType.SummaryRecord).length > 0;
        this._isTreeGrid = this._data.filter(d => d.type === ExportRecordType.TreeGridRecord).length > 0;
        this._isPivotGrid = this.data[0]?.type === ExportRecordType.PivotGridRecord;
        const exportMultiColumnHeaders = this._hasMultiColumnHeader && !this.options.ignoreMultiColumnHeaders;
        if (this._isHierarchical || exportMultiColumnHeaders || this._isPivotGrid) {
            this.options.exportAsTable = false;
        }
        if (!this._data || this._data.length === 0) {
            if (!this._isHierarchical) {
                this._rowCount = this.owner.maxLevel + 1;
            }
            return;
        }
        this._isSpecialData = ExportUtilities.isSpecialData(this._data[0].data);
        this._rowCount = this._data.length + this.multiColumnHeaderRows + 1;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29ya3NoZWV0LWRhdGEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9pZ25pdGV1aS1hbmd1bGFyL3NyYy9saWIvc2VydmljZXMvZXhjZWwvd29ya3NoZWV0LWRhdGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxnQkFBZ0IsRUFBOEIsTUFBTSx3Q0FBd0MsQ0FBQztBQUNsSCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFFdEUsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFFdEUsY0FBYztBQUNkLE1BQU0sT0FBTyxhQUFhO0lBWXRCLFlBQW9CLEtBQXNCLEVBQ3ZCLE9BQWdDLEVBQ2hDLElBQVMsRUFDVCxXQUFtQixFQUNuQixRQUFrQixFQUNsQix1QkFBK0IsRUFDL0IsWUFBc0IsRUFDdEIsS0FBa0IsRUFDbEIsTUFBNkI7UUFSNUIsVUFBSyxHQUFMLEtBQUssQ0FBaUI7UUFDdkIsWUFBTyxHQUFQLE9BQU8sQ0FBeUI7UUFDaEMsU0FBSSxHQUFKLElBQUksQ0FBSztRQUNULGdCQUFXLEdBQVgsV0FBVyxDQUFRO1FBQ25CLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDbEIsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUFRO1FBQy9CLGlCQUFZLEdBQVosWUFBWSxDQUFVO1FBQ3RCLFVBQUssR0FBTCxLQUFLLENBQWE7UUFDbEIsV0FBTSxHQUFOLE1BQU0sQ0FBdUI7UUFDeEMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQzlCLENBQUM7SUFFRCxJQUFXLElBQUk7UUFDWCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDdEIsQ0FBQztJQUVELElBQVcsUUFBUTtRQUNmLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUMxQixDQUFDO0lBRUQsSUFBVyxPQUFPO1FBQ2QsT0FBTyxDQUFDLElBQUksQ0FB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QUksSUFBSSxDQUFDLFlBQVksRUFBRTtZQUN2RSxJQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUM7U0FDdEM7UUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDeEMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUU7Z0JBQ3ZCLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDO2FBQzVDO1lBRUQsT0FBTztTQUNWO1FBRUQsSUFBSSxDQUFDLGNBQWMsR0FBRyxlQUFlLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDeEUsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMscUJBQXFCLEdBQUcsQ0FBQyxDQUFDO0lBQ3hFLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEhlYWRlclR5cGUsIEV4cG9ydFJlY29yZFR5cGUsIElDb2x1bW5MaXN0LCBJRXhwb3J0UmVjb3JkIH0gZnJvbSAnLi4vZXhwb3J0ZXItY29tbW9uL2Jhc2UtZXhwb3J0LXNlcnZpY2UnO1xuaW1wb3J0IHsgRXhwb3J0VXRpbGl0aWVzIH0gZnJvbSAnLi4vZXhwb3J0ZXItY29tbW9uL2V4cG9ydC11dGlsaXRpZXMnO1xuaW1wb3J0IHsgSWd4RXhjZWxFeHBvcnRlck9wdGlvbnMgfSBmcm9tICcuL2V4Y2VsLWV4cG9ydGVyLW9wdGlvbnMnO1xuaW1wb3J0IHsgV29ya3NoZWV0RGF0YURpY3Rpb25hcnkgfSBmcm9tICcuL3dvcmtzaGVldC1kYXRhLWRpY3Rpb25hcnknO1xuXG4vKiogQGhpZGRlbiAqL1xuZXhwb3J0IGNsYXNzIFdvcmtzaGVldERhdGEge1xuICAgIHByaXZhdGUgX3Jvd0NvdW50OiBudW1iZXI7XG4gICAgcHJpdmF0ZSBfZGF0YURpY3Rpb25hcnk6IFdvcmtzaGVldERhdGFEaWN0aW9uYXJ5O1xuICAgIHByaXZhdGUgX2lzU3BlY2lhbERhdGE6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBfaGFzTXVsdGlDb2x1bW5IZWFkZXI6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBfaGFzTXVsdGlSb3dIZWFkZXI6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBfaXNIaWVyYXJjaGljYWw6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBfaGFzU3VtbWFyaWVzOiBib29sZWFuO1xuICAgIHByaXZhdGUgX2lzUGl2b3RHcmlkOiBib29sZWFuO1xuICAgIHByaXZhdGUgX2lzVHJlZUdyaWQ6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBfaXNHcm91cGVkR3JpZDogYm9vbGVhbjtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgX2RhdGE6IElFeHBvcnRSZWNvcmRbXSxcbiAgICAgICAgICAgICAgICBwdWJsaWMgb3B0aW9uczogSWd4RXhjZWxFeHBvcnRlck9wdGlvbnMsXG4gICAgICAgICAgICAgICAgcHVibGljIHNvcnQ6IGFueSxcbiAgICAgICAgICAgICAgICBwdWJsaWMgY29sdW1uQ291bnQ6IG51bWJlcixcbiAgICAgICAgICAgICAgICBwdWJsaWMgcm9vdEtleXM6IHN0cmluZ1tdLFxuICAgICAgICAgICAgICAgIHB1YmxpYyBpbmRleE9mTGFzdFBpbm5lZENvbHVtbjogbnVtYmVyLFxuICAgICAgICAgICAgICAgIHB1YmxpYyBjb2x1bW5XaWR0aHM6IG51bWJlcltdLFxuICAgICAgICAgICAgICAgIHB1YmxpYyBvd25lcjogSUNvbHVtbkxpc3QsXG4gICAgICAgICAgICAgICAgcHVibGljIG93bmVyczogTWFwPGFueSwgSUNvbHVtbkxpc3Q+KSB7XG4gICAgICAgICAgICB0aGlzLmluaXRpYWxpemVEYXRhKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBkYXRhKCk6IElFeHBvcnRSZWNvcmRbXSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9kYXRhO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgcm93Q291bnQoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3Jvd0NvdW50O1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgaXNFbXB0eSgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICF0aGlzLnJvd0NvdW50XG4gICAgICAgICAgICB8fCB0aGlzLnJvd0NvdW50ID09PSB0aGlzLm93bmVyLm1heExldmVsICsgMVxuICAgICAgICAgICAgfHwgIXRoaXMuY29sdW1uQ291bnRcbiAgICAgICAgICAgIHx8IHRoaXMub3duZXIuY29sdW1ucy5ldmVyeShjID0+IGMuc2tpcCk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBpc1NwZWNpYWxEYXRhKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5faXNTcGVjaWFsRGF0YTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGRhdGFEaWN0aW9uYXJ5KCk6IFdvcmtzaGVldERhdGFEaWN0aW9uYXJ5IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2RhdGFEaWN0aW9uYXJ5O1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgaGFzTXVsdGlDb2x1bW5IZWFkZXIoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9oYXNNdWx0aUNvbHVtbkhlYWRlcjtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGhhc1N1bW1hcmllcygpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2hhc1N1bW1hcmllcztcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGhhc011bHRpUm93SGVhZGVyKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5faGFzTXVsdGlSb3dIZWFkZXI7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBpc0hpZXJhcmNoaWNhbCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2lzSGllcmFyY2hpY2FsO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgaXNUcmVlR3JpZCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2lzVHJlZUdyaWQ7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBpc1Bpdm90R3JpZCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2lzUGl2b3RHcmlkO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgaXNHcm91cGVkR3JpZCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2RhdGEuc29tZShkID0+IGQudHlwZSA9PT0gRXhwb3J0UmVjb3JkVHlwZS5Hcm91cGVkUmVjb3JkKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IG1heExldmVsKCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiBbLi4ubmV3IFNldCh0aGlzLl9kYXRhLm1hcChpdGVtID0+IGl0ZW0ubGV2ZWwpKV0uc29ydCgoYSxiKSA9PiAoYSA+IGIgPyAtMSA6IDEpKVswXTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IG11bHRpQ29sdW1uSGVhZGVyUm93cygpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gIXRoaXMub3B0aW9ucy5pZ25vcmVNdWx0aUNvbHVtbkhlYWRlcnMgPyBBcnJheS5mcm9tKHRoaXMub3duZXJzLnZhbHVlcygpKS5tYXAoYyA9PiBjLm1heExldmVsKS5yZWR1Y2UoKGEsYikgPT4gYSArIGIpIDogMDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGluaXRpYWxpemVEYXRhKCkge1xuICAgICAgICB0aGlzLl9kYXRhRGljdGlvbmFyeSA9IG5ldyBXb3Jrc2hlZXREYXRhRGljdGlvbmFyeSh0aGlzLmNvbHVtbkNvdW50LCB0aGlzLm9wdGlvbnMuY29sdW1uV2lkdGgsIHRoaXMuY29sdW1uV2lkdGhzKTtcblxuICAgICAgICB0aGlzLl9oYXNNdWx0aUNvbHVtbkhlYWRlciA9IEFycmF5LmZyb20odGhpcy5vd25lcnMudmFsdWVzKCkpXG4gICAgICAgICAgICAuc29tZShvID0+IG8uY29sdW1ucy5zb21lKGNvbCA9PiAhY29sLnNraXAgJiYgY29sLmhlYWRlclR5cGUgPT09IEhlYWRlclR5cGUuTXVsdGlDb2x1bW5IZWFkZXIpKTtcblxuICAgICAgICB0aGlzLl9oYXNNdWx0aVJvd0hlYWRlciA9IEFycmF5LmZyb20odGhpcy5vd25lcnMudmFsdWVzKCkpXG4gICAgICAgICAgICAuc29tZShvID0+IG8uY29sdW1ucy5zb21lKGNvbCA9PiAhY29sLnNraXAgJiYgY29sLmhlYWRlclR5cGUgPT09IEhlYWRlclR5cGUuTXVsdGlSb3dIZWFkZXIpKTtcblxuICAgICAgICB0aGlzLl9pc0hpZXJhcmNoaWNhbCA9IHRoaXMuZGF0YVswXT8udHlwZSA9PT0gRXhwb3J0UmVjb3JkVHlwZS5IaWVyYXJjaGljYWxHcmlkUmVjb3JkXG4gICAgICAgICAgICB8fCAhKHR5cGVvZihBcnJheS5mcm9tKHRoaXMub3duZXJzLmtleXMoKSlbMF0pID09PSAnc3RyaW5nJyk7XG5cbiAgICAgICAgdGhpcy5faGFzU3VtbWFyaWVzID0gdGhpcy5fZGF0YS5maWx0ZXIoZCA9PiBkLnR5cGUgPT09IEV4cG9ydFJlY29yZFR5cGUuU3VtbWFyeVJlY29yZCkubGVuZ3RoID4gMDtcblxuICAgICAgICB0aGlzLl9pc1RyZWVHcmlkID0gdGhpcy5fZGF0YS5maWx0ZXIoZCA9PiBkLnR5cGUgPT09IEV4cG9ydFJlY29yZFR5cGUuVHJlZUdyaWRSZWNvcmQpLmxlbmd0aCA+IDA7XG5cbiAgICAgICAgdGhpcy5faXNQaXZvdEdyaWQgPSB0aGlzLmRhdGFbMF0/LnR5cGUgPT09IEV4cG9ydFJlY29yZFR5cGUuUGl2b3RHcmlkUmVjb3JkO1xuXG4gICAgICAgIGNvbnN0IGV4cG9ydE11bHRpQ29sdW1uSGVhZGVycyA9IHRoaXMuX2hhc011bHRpQ29sdW1uSGVhZGVyICYmICF0aGlzLm9wdGlvbnMuaWdub3JlTXVsdGlDb2x1bW5IZWFkZXJzO1xuXG4gICAgICAgIGlmICh0aGlzLl9pc0hpZXJhcmNoaWNhbCB8fCBleHBvcnRNdWx0aUNvbHVtbkhlYWRlcnMgfHwgdGhpcy5faXNQaXZvdEdyaWQpIHtcbiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5leHBvcnRBc1RhYmxlID0gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXRoaXMuX2RhdGEgfHwgdGhpcy5fZGF0YS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5faXNIaWVyYXJjaGljYWwpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9yb3dDb3VudCA9IHRoaXMub3duZXIubWF4TGV2ZWwgKyAxO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9pc1NwZWNpYWxEYXRhID0gRXhwb3J0VXRpbGl0aWVzLmlzU3BlY2lhbERhdGEodGhpcy5fZGF0YVswXS5kYXRhKTtcbiAgICAgICAgdGhpcy5fcm93Q291bnQgPSB0aGlzLl9kYXRhLmxlbmd0aCArIHRoaXMubXVsdGlDb2x1bW5IZWFkZXJSb3dzICsgMTtcbiAgICB9XG59XG4iXX0=